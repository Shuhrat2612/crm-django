{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4 px-4">
    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <h5 class="card-title">Customers</h5>
                    <h2 class="display-4 mb-0">{{ customers_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <h5 class="card-title">Leads</h5>
                    <h2 class="display-4 mb-0">{{ leads_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <h5 class="card-title">Deals</h5>
                    <h2 class="display-4 mb-0">{{ deals_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <h5 class="card-title">Tasks</h5>
                    <h2 class="display-4 mb-0">{{ tasks_count }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Leads by Status</h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="leadsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Deal Values by Month</h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="dealsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Tasks by Priority</h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="tasksChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Deals by Status</h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="dealsStatusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activities -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Recent Tasks</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for task in recent_tasks %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ task.title }}</h6>
                                <small class="text-muted">{{ task.created_at|date:"M d, Y" }}</small>
                            </div>
                            <p class="mb-1 text-muted">{{ task.description|truncatechars:100 }}</p>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-tasks fa-2x mb-2"></i>
                            <p>No recent tasks</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Recent Deals</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for deal in recent_deals %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ deal.title }}</h6>
                                <small class="text-muted">{{ deal.created_at|date:"M d, Y" }}</small>
                            </div>
                            <p class="mb-1">
                                <span class="badge bg-success">${{ deal.value }}</span>
                                <span class="badge bg-info">{{ deal.status }}</span>
                            </p>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-handshake fa-2x mb-2"></i>
                            <p>No recent deals</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Common chart options
const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'bottom',
            labels: {
                padding: 20,
                usePointStyle: true
            }
        },
        tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12,
            titleFont: {
                size: 14
            },
            bodyFont: {
                size: 13
            }
        }
    }
};

// Leads Chart
new Chart(document.getElementById('leadsChart'), {
    type: 'pie',
    data: {
        labels: {{ leads_status_labels|safe }},
        datasets: [{
            data: {{ leads_status_data|safe }},
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF'
            ],
            borderWidth: 2
        }]
    },
    options: {
        ...commonOptions,
        plugins: {
            ...commonOptions.plugins,
            title: {
                display: true,
                text: 'Lead Distribution',
                font: {
                    size: 16
                }
            }
        }
    }
});

// Deals Chart
new Chart(document.getElementById('dealsChart'), {
    type: 'line',
    data: {
        labels: {{ deals_months|safe }},
        datasets: [{
            label: 'Deal Value ($)',
            data: {{ deals_values|safe }},
            borderColor: '#36A2EB',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.3,
            fill: true,
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            label += new Intl.NumberFormat('en-US', {
                                style: 'currency',
                                currency: 'USD'
                            }).format(context.parsed.y);
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Tasks Chart
new Chart(document.getElementById('tasksChart'), {
    type: 'bar',
    data: {
        labels: {{ tasks_priority_labels|safe }},
        datasets: [{
            label: 'Number of Tasks',
            data: {{ tasks_priority_data|safe }},
            backgroundColor: [
                'rgba(75, 192, 192, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(255, 99, 132, 0.7)'
            ],
            borderColor: [
                'rgb(75, 192, 192)',
                'rgb(255, 159, 64)',
                'rgb(255, 99, 132)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        ...commonOptions,
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    drawBorder: false
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        },
        plugins: {
            ...commonOptions.plugins,
            title: {
                display: true,
                text: 'Task Distribution by Priority',
                font: {
                    size: 16
                }
            }
        }
    }
});

// Deals Status Chart
new Chart(document.getElementById('dealsStatusChart'), {
    type: 'doughnut',
    data: {
        labels: {{ deals_status_labels|safe }},
        datasets: [{
            data: {{ deals_status_counts|safe }},
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)'
            ],
            borderColor: [
                'rgb(255, 99, 132)',
                'rgb(54, 162, 235)',
                'rgb(255, 206, 86)',
                'rgb(75, 192, 192)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        ...commonOptions,
        cutout: '60%',
        plugins: {
            ...commonOptions.plugins,
            title: {
                display: true,
                text: 'Deal Status Distribution',
                font: {
                    size: 16
                }
            }
        }
    }
});
</script>
{% endblock %} 